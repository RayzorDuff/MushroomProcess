-- Generated by airtable_export_to_postgres_sql_v2.js
-- 2026-01-25T18:46:49.175Z
BEGIN;
DROP VIEW IF EXISTS "public"."vc_strains" CASCADE;
DROP VIEW IF EXISTS "public"."vc_recipes" CASCADE;
DROP VIEW IF EXISTS "public"."vc_products" CASCADE;
DROP VIEW IF EXISTS "public"."vc_lots" CASCADE;
DROP VIEW IF EXISTS "public"."vc_items" CASCADE;
DROP VIEW IF EXISTS "public"."vc_events" CASCADE;
DROP VIEW IF EXISTS "public"."vc_locations" CASCADE;
DROP VIEW IF EXISTS "public"."vc_sterilization_runs" CASCADE;
DROP VIEW IF EXISTS "public"."vc_print_queue" CASCADE;
DROP VIEW IF EXISTS "public"."vc_ecommerce" CASCADE;
DROP VIEW IF EXISTS "public"."vc_ecommerce_orders" CASCADE;

CREATE VIEW "public"."vc_strains" AS SELECT * FROM "public"."v_strains";

CREATE VIEW "public"."vc_recipes" AS SELECT * FROM "public"."v_recipes";

CREATE VIEW "public"."vc_products" AS
SELECT base.*,
  (SELECT COALESCE(array_agg(btbl."name" ORDER BY btbl."name") FILTER (WHERE btbl."name" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_items_item_id" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."products_id" = base.nocopk) AS "name",
  (SELECT COALESCE(array_agg(btbl."category" ORDER BY btbl."category") FILTER (WHERE btbl."category" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_items_item_id" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."products_id" = base.nocopk) AS "item_category",
  (SELECT COALESCE(array_agg(btbl."name" ORDER BY btbl."name") FILTER (WHERE btbl."name" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_items_package_item" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."products_id" = base.nocopk) AS "name_from_package_item",
  (SELECT COALESCE(array_agg(btbl."category" ORDER BY btbl."category") FILTER (WHERE btbl."category" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_items_package_item" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."products_id" = base.nocopk) AS "package_item_category",
  (SELECT COALESCE(array_agg(btbl."unit_lbs" ORDER BY btbl."unit_lbs") FILTER (WHERE btbl."unit_lbs" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."products_id" = base.nocopk) AS "unit_lbs",
  (SELECT COALESCE(array_agg(btbl."unit_size" ORDER BY btbl."unit_size") FILTER (WHERE btbl."unit_size" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."products_id" = base.nocopk) AS "unit_size",
  (SELECT COALESCE(array_agg(btbl."label_inoc_line" ORDER BY btbl."label_inoc_line") FILTER (WHERE btbl."label_inoc_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."products_id" = base.nocopk) AS "label_inoc_prod",
  (SELECT COALESCE(array_agg(btbl."label_spawned_line" ORDER BY btbl."label_spawned_line") FILTER (WHERE btbl."label_spawned_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."products_id" = base.nocopk) AS "label_spawned_prod",
  (SELECT COALESCE(array_agg(btbl."label_proc_line" ORDER BY btbl."label_proc_line") FILTER (WHERE btbl."label_proc_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."products_id" = base.nocopk) AS "label_proc_prod",
  (SELECT COALESCE(array_agg(btbl."process_type_from_steri_run_id" ORDER BY btbl."process_type_from_steri_run_id") FILTER (WHERE btbl."process_type_from_steri_run_id" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."products_id" = base.nocopk) AS "process_type",
  (SELECT COALESCE(array_agg(btbl."species_strain" ORDER BY btbl."species_strain") FILTER (WHERE btbl."species_strain" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_strains_strain_id" j JOIN "public"."strains" btbl ON btbl.nocopk = j."strains_id" WHERE j."products_id" = base.nocopk) AS "species_strain",
  (SELECT COALESCE(array_agg(btbl."regulated" ORDER BY btbl."regulated") FILTER (WHERE btbl."regulated" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_products_strains_strain_id" j JOIN "public"."strains" btbl ON btbl.nocopk = j."strains_id" WHERE j."products_id" = base.nocopk) AS "origin_strain_regulated"
FROM "public"."v_products" base;

-- TODO(rollup): lots.inoculated_at (from grain_inputs) (Airtable rollup aggregation formula not exported); emitted as array_agg
-- TODO(rollup): lots.spawned_date (Airtable rollup aggregation formula not exported); emitted as array_agg
-- TODO(rollup): lots.last_inoculation_date (Airtable rollup aggregation formula not exported); emitted as array_agg
-- TODO(rollup): lots.first_event_date (Airtable rollup aggregation formula not exported); emitted as array_agg
-- TODO(rollup): lots.last_event_date (Airtable rollup aggregation formula not exported); emitted as array_agg
CREATE VIEW "public"."vc_lots" AS
SELECT base.*,
  (SELECT COALESCE(array_agg(btbl."name" ORDER BY btbl."name") FILTER (WHERE btbl."name" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_items_item_id" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."lots_id" = base.nocopk) AS "item_name",
  (SELECT COALESCE(array_agg(btbl."name" ORDER BY btbl."name") FILTER (WHERE btbl."name" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_recipes_recipe_id" j JOIN "public"."recipes" btbl ON btbl.nocopk = j."recipes_id" WHERE j."lots_id" = base.nocopk) AS "recipe_name",
  (SELECT COALESCE(array_agg(btbl."regulated" ORDER BY btbl."regulated") FILTER (WHERE btbl."regulated" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_strains_strain_id" j JOIN "public"."strains" btbl ON btbl.nocopk = j."strains_id" WHERE j."lots_id" = base.nocopk) AS "regulated_from_strain_id",
  (SELECT COALESCE(array_agg(btbl."species_strain" ORDER BY btbl."species_strain") FILTER (WHERE btbl."species_strain" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_strains_strain_id" j JOIN "public"."strains" btbl ON btbl.nocopk = j."strains_id" WHERE j."lots_id" = base.nocopk) AS "strain_species_strain",
  (SELECT COALESCE(array_agg(btbl."process_type" ORDER BY btbl."process_type") FILTER (WHERE btbl."process_type" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_sterilization_runs_steri_run_id" j JOIN "public"."sterilization_runs" btbl ON btbl.nocopk = j."sterilization_runs_id" WHERE j."lots_id" = base.nocopk) AS "process_type_from_steri_run_id",
  (SELECT COALESCE(array_agg(btbl."category" ORDER BY btbl."category") FILTER (WHERE btbl."category" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_items_item_id" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."lots_id" = base.nocopk) AS "item_category",
  (SELECT COALESCE(array_agg(btbl."strain_species_strain" ORDER BY btbl."strain_species_strain") FILTER (WHERE btbl."strain_species_strain" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_lots_target_lot_ids" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."lots_id" = base.nocopk) AS "strain_species_strain_from_lc_lot_id",
  (SELECT COALESCE(array_agg(btbl."vendor_name" ORDER BY btbl."vendor_name") FILTER (WHERE btbl."vendor_name" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_lots_target_lot_ids" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."lots_id" = base.nocopk) AS "vendor_name_from_lc_lot_id",
  (SELECT COALESCE(array_agg(btbl."item_name_mat" ORDER BY btbl."item_name_mat") FILTER (WHERE btbl."item_name_mat" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_lots_grain_inputs" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."lots_id" = base.nocopk) AS "item_name_mat_from_grain_inputs",
  (SELECT COALESCE(array_agg(btbl."inoculated_at" ORDER BY btbl."inoculated_at") FILTER (WHERE btbl."inoculated_at" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_lots_grain_inputs" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."lots_id" = base.nocopk) AS "inoculated_at_from_grain_inputs",
  (SELECT COALESCE(array_agg(btbl."process_type_mat" ORDER BY btbl."process_type_mat") FILTER (WHERE btbl."process_type_mat" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_lots_substrate_inputs" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."lots_id" = base.nocopk) AS "process_type_mat_from_substrate_inputs",
  (SELECT COALESCE(array_agg(btbl."item_name_mat" ORDER BY btbl."item_name_mat") FILTER (WHERE btbl."item_name_mat" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_lots_substrate_inputs" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."lots_id" = base.nocopk) AS "item_name_mat_from_substrate_inputs",
  (SELECT COALESCE(array_agg(btbl."category" ORDER BY btbl."category") FILTER (WHERE btbl."category" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_items_harvest_item" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."lots_id" = base.nocopk) AS "harvest_item_category",
  (SELECT COALESCE(array_agg(btbl."name" ORDER BY btbl."name") FILTER (WHERE btbl."name" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_products_products" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."lots_id" = base.nocopk) AS "name_from_products",
  (SELECT COALESCE(array_agg(btbl."item_category" ORDER BY btbl."item_category") FILTER (WHERE btbl."item_category" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_products_products" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."lots_id" = base.nocopk) AS "category_from_item_id_from_products",
  (SELECT COALESCE(array_agg(btbl."timestamp" ORDER BY btbl."timestamp") FILTER (WHERE btbl."timestamp" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_events_events" j JOIN "public"."events" btbl ON btbl.nocopk = j."events_id" WHERE j."lots_id" = base.nocopk) AS "spawned_date",
  (SELECT COALESCE(array_agg(btbl."timestamp" ORDER BY btbl."timestamp") FILTER (WHERE btbl."timestamp" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_events_events" j JOIN "public"."events" btbl ON btbl.nocopk = j."events_id" WHERE j."lots_id" = base.nocopk) AS "last_inoculation_date",
  (SELECT COALESCE(array_agg(btbl."timestamp" ORDER BY btbl."timestamp") FILTER (WHERE btbl."timestamp" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_events_events" j JOIN "public"."events" btbl ON btbl.nocopk = j."events_id" WHERE j."lots_id" = base.nocopk) AS "first_event_date",
  (SELECT COALESCE(array_agg(btbl."timestamp" ORDER BY btbl."timestamp") FILTER (WHERE btbl."timestamp" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_lots_events_events" j JOIN "public"."events" btbl ON btbl.nocopk = j."events_id" WHERE j."lots_id" = base.nocopk) AS "last_event_date"
FROM "public"."v_lots" base;

CREATE VIEW "public"."vc_items" AS SELECT * FROM "public"."v_items";

CREATE VIEW "public"."vc_events" AS
SELECT base.*,
  (SELECT COALESCE(array_agg(btbl."status" ORDER BY btbl."status") FILTER (WHERE btbl."status" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."events_id" = base.nocopk) AS "status_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."storage_location" ORDER BY btbl."storage_location") FILTER (WHERE btbl."storage_location" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_events_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."events_id" = base.nocopk) AS "storage_location_from_product_id",
  (SELECT COALESCE(array_agg(btbl."grain_inputs" ORDER BY btbl."grain_inputs") FILTER (WHERE btbl."grain_inputs" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."events_id" = base.nocopk) AS "grain_inputs_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."substrate_inputs" ORDER BY btbl."substrate_inputs") FILTER (WHERE btbl."substrate_inputs" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."events_id" = base.nocopk) AS "substrate_inputs_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."vendor_name_from_lc_lot_id" ORDER BY btbl."vendor_name_from_lc_lot_id") FILTER (WHERE btbl."vendor_name_from_lc_lot_id" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."events_id" = base.nocopk) AS "vendor_name_from_lc_lot_id_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."strain_species_strain" ORDER BY btbl."strain_species_strain") FILTER (WHERE btbl."strain_species_strain" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."events_id" = base.nocopk) AS "strain_species_strain_from_lot_id"
FROM "public"."v_events" base;

CREATE VIEW "public"."vc_locations" AS SELECT * FROM "public"."v_locations";

CREATE VIEW "public"."vc_sterilization_runs" AS
SELECT base.*,
  (SELECT COALESCE(array_agg(btbl."default_unit_size" ORDER BY btbl."default_unit_size") FILTER (WHERE btbl."default_unit_size" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_sterilization_runs_items_planned_item" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."sterilization_runs_id" = base.nocopk) AS "default_unit_size_from_planned_item",
  (SELECT COALESCE(array_agg(btbl."item_id" ORDER BY btbl."item_id") FILTER (WHERE btbl."item_id" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_sterilization_runs_items_planned_item" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."sterilization_runs_id" = base.nocopk) AS "planned_item_id",
  (SELECT COALESCE(array_agg(btbl."name" ORDER BY btbl."name") FILTER (WHERE btbl."name" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_sterilization_runs_items_planned_item" j JOIN "public"."items" btbl ON btbl.nocopk = j."items_id" WHERE j."sterilization_runs_id" = base.nocopk) AS "planned_item_name",
  (SELECT COALESCE(array_agg(btbl."recipe_id" ORDER BY btbl."recipe_id") FILTER (WHERE btbl."recipe_id" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_sterilization_runs_recipes_planned_recipe" j JOIN "public"."recipes" btbl ON btbl.nocopk = j."recipes_id" WHERE j."sterilization_runs_id" = base.nocopk) AS "recipe_id_from_planned_recipe",
  (SELECT COALESCE(array_agg(btbl."name" ORDER BY btbl."name") FILTER (WHERE btbl."name" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_sterilization_runs_recipes_planned_recipe" j JOIN "public"."recipes" btbl ON btbl.nocopk = j."recipes_id" WHERE j."sterilization_runs_id" = base.nocopk) AS "name_from_planned_recipe"
FROM "public"."v_sterilization_runs" base;

CREATE VIEW "public"."vc_print_queue" AS
SELECT base.*,
  (SELECT COALESCE(array_agg(btbl."item_category_mat" ORDER BY btbl."item_category_mat") FILTER (WHERE btbl."item_category_mat" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "item_category_mat_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."public_link" ORDER BY btbl."public_link") FILTER (WHERE btbl."public_link" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "public_link_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_company_lot" ORDER BY btbl."label_company_lot") FILTER (WHERE btbl."label_company_lot" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_company_lot_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."item_category_mat" ORDER BY btbl."item_category_mat") FILTER (WHERE btbl."item_category_mat" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "item_category_mat_from_product_id",
  (SELECT COALESCE(array_agg(btbl."public_link" ORDER BY btbl."public_link") FILTER (WHERE btbl."public_link" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "public_link_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_substrateinputblocks_line" ORDER BY btbl."label_substrateinputblocks_line") FILTER (WHERE btbl."label_substrateinputblocks_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_substrateinputblocks_line_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_graininputblocks_line" ORDER BY btbl."label_graininputblocks_line") FILTER (WHERE btbl."label_graininputblocks_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_graininputblocks_line_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_footer_lot" ORDER BY btbl."label_footer_lot") FILTER (WHERE btbl."label_footer_lot" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_footer_lot_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_subtitle_lot" ORDER BY btbl."label_subtitle_lot") FILTER (WHERE btbl."label_subtitle_lot" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_subtitle_lot_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_title_lot" ORDER BY btbl."label_title_lot") FILTER (WHERE btbl."label_title_lot" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_title_lot_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_template" ORDER BY btbl."label_template") FILTER (WHERE btbl."label_template" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_template_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_useby_line" ORDER BY btbl."label_useby_line") FILTER (WHERE btbl."label_useby_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_useby_line_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_spawned_line" ORDER BY btbl."label_spawned_line") FILTER (WHERE btbl."label_spawned_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_spawned_line_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_inoc_line" ORDER BY btbl."label_inoc_line") FILTER (WHERE btbl."label_inoc_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_inoc_line_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_proc_line" ORDER BY btbl."label_proc_line") FILTER (WHERE btbl."label_proc_line" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."print_queue_id" = base.nocopk) AS "label_proc_line_from_lot_id",
  (SELECT COALESCE(array_agg(btbl."label_company_prod" ORDER BY btbl."label_company_prod") FILTER (WHERE btbl."label_company_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_company_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_title_prod" ORDER BY btbl."label_title_prod") FILTER (WHERE btbl."label_title_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_title_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_subtitle_prod" ORDER BY btbl."label_subtitle_prod") FILTER (WHERE btbl."label_subtitle_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_subtitle_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_footer_prod" ORDER BY btbl."label_footer_prod") FILTER (WHERE btbl."label_footer_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_footer_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_cottage_prod" ORDER BY btbl."label_cottage_prod") FILTER (WHERE btbl."label_cottage_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_cottage_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_companyinfo_prod" ORDER BY btbl."label_companyinfo_prod") FILTER (WHERE btbl."label_companyinfo_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_companyinfo_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_disclaimer_prod" ORDER BY btbl."label_disclaimer_prod") FILTER (WHERE btbl."label_disclaimer_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_disclaimer_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_companyaddress_prod" ORDER BY btbl."label_companyaddress_prod") FILTER (WHERE btbl."label_companyaddress_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_companyaddress_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_packaged_prod" ORDER BY btbl."label_packaged_prod") FILTER (WHERE btbl."label_packaged_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_packaged_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_useby_prod" ORDER BY btbl."label_useby_prod") FILTER (WHERE btbl."label_useby_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_useby_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_proc_prod" ORDER BY btbl."label_proc_prod") FILTER (WHERE btbl."label_proc_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_proc_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_spawned_prod" ORDER BY btbl."label_spawned_prod") FILTER (WHERE btbl."label_spawned_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_spawned_prod_from_product_id",
  (SELECT COALESCE(array_agg(btbl."label_inoc_prod" ORDER BY btbl."label_inoc_prod") FILTER (WHERE btbl."label_inoc_prod" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."print_queue_id" = base.nocopk) AS "label_inoc_prod_from_product_id"
FROM "public"."v_print_queue" base;

-- TODO(rollup): ecommerce.available_from_products (Airtable rollup aggregation formula not exported); emitted as array_agg
-- TODO(rollup): ecommerce.available_from_lots (Airtable rollup aggregation formula not exported); emitted as array_agg
CREATE VIEW "public"."vc_ecommerce" AS
SELECT base.*,
  (SELECT COALESCE(array_agg(btbl."product_id" ORDER BY btbl."product_id") FILTER (WHERE btbl."product_id" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_ecommerce_products_products" j JOIN "public"."products" btbl ON btbl.nocopk = j."products_id" WHERE j."ecommerce_id" = base.nocopk) AS "available_from_products",
  (SELECT COALESCE(array_agg(btbl."lot_id" ORDER BY btbl."lot_id") FILTER (WHERE btbl."lot_id" IS NOT NULL), '{}'::text[]) FROM "public"."_m2m_ecommerce_lots_lots" j JOIN "public"."lots" btbl ON btbl.nocopk = j."lots_id" WHERE j."ecommerce_id" = base.nocopk) AS "available_from_lots"
FROM "public"."v_ecommerce" base;

CREATE VIEW "public"."vc_ecommerce_orders" AS SELECT * FROM "public"."v_ecommerce_orders";

COMMIT;
