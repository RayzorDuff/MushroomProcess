-- Generated by airtable_export_to_postgres_sql_v3.js
-- 2026-01-29T21:53:12.928Z
BEGIN;
DROP VIEW IF EXISTS "public"."vc_strains" CASCADE;
DROP VIEW IF EXISTS "public"."vc_recipes" CASCADE;
DROP VIEW IF EXISTS "public"."vc_products" CASCADE;
DROP VIEW IF EXISTS "public"."vc_lots" CASCADE;
DROP VIEW IF EXISTS "public"."vc_items" CASCADE;
DROP VIEW IF EXISTS "public"."vc_events" CASCADE;
DROP VIEW IF EXISTS "public"."vc_locations" CASCADE;
DROP VIEW IF EXISTS "public"."vc_sterilization_runs" CASCADE;
DROP VIEW IF EXISTS "public"."vc_print_queue" CASCADE;
DROP VIEW IF EXISTS "public"."vc_ecommerce" CASCADE;
DROP VIEW IF EXISTS "public"."vc_ecommerce_orders" CASCADE;

CREATE VIEW "public"."vc_strains" AS SELECT * FROM "public"."v_strains";

CREATE VIEW "public"."vc_recipes" AS SELECT * FROM "public"."v_recipes";

CREATE VIEW "public"."vc_lots" AS
WITH comp AS (
  SELECT base.*,
    (SELECT COALESCE(array_agg(((btbl."name")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_items_item_id" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."lots_id" = base."nocopk") AS "item_name",
    (SELECT COALESCE(array_agg(((btbl."name")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_recipes_recipe_id" j JOIN "public"."recipes" btbl ON btbl."nocopk" = j."recipes_id" WHERE j."lots_id" = base."nocopk") AS "recipe_name",
    (SELECT COALESCE(array_agg(((btbl."regulated")::boolean) ORDER BY btbl."nocopk"), ARRAY[]::boolean[]) FROM "public"."_m2m_lots_strains_strain_id" j JOIN "public"."strains" btbl ON btbl."nocopk" = j."strains_id" WHERE j."lots_id" = base."nocopk") AS "regulated_from_strain_id",
    (SELECT COALESCE(array_agg(((btbl."species_strain")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_strains_strain_id" j JOIN "public"."strains" btbl ON btbl."nocopk" = j."strains_id" WHERE j."lots_id" = base."nocopk") AS "strain_species_strain",
    (SELECT COALESCE(array_agg(((btbl."process_type")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_sterilization_runs_steri_run_id" j JOIN "public"."sterilization_runs" btbl ON btbl."nocopk" = j."sterilization_runs_id" WHERE j."lots_id" = base."nocopk") AS "process_type_from_steri_run_id",
    (SELECT COALESCE(array_agg(((btbl."category")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_items_item_id" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."lots_id" = base."nocopk") AS "item_category",
    (SELECT COALESCE(array_agg(((btbl."item_name_mat")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_lots_grain_inputs" j JOIN "public"."v_lots" btbl ON btbl."nocopk" = j."lots1_id" WHERE j."lots_id" = base."nocopk") AS "item_name_mat_from_grain_inputs",
    (SELECT COALESCE(array_agg(((btbl."inoculated_at")::timestamp without time zone) ORDER BY btbl."nocopk"), ARRAY[]::timestamp without time zone[]) FROM "public"."_m2m_lots_lots_grain_inputs" j JOIN "public"."v_lots" btbl ON btbl."nocopk" = j."lots1_id" WHERE j."lots_id" = base."nocopk") AS "inoculated_at_from_grain_inputs",
    (SELECT COALESCE(array_agg(((btbl."process_type_mat")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_lots_substrate_inputs" j JOIN "public"."v_lots" btbl ON btbl."nocopk" = j."lots1_id" WHERE j."lots_id" = base."nocopk") AS "process_type_mat_from_substrate_inputs",
    (SELECT COALESCE(array_agg(((btbl."item_name_mat")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_lots_substrate_inputs" j JOIN "public"."v_lots" btbl ON btbl."nocopk" = j."lots1_id" WHERE j."lots_id" = base."nocopk") AS "item_name_mat_from_substrate_inputs",
    (SELECT COALESCE(array_agg(((btbl."category")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_lots_items_harvest_item" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."lots_id" = base."nocopk") AS "harvest_item_category",
    (SELECT COALESCE(array_agg(((btbl."timestamp")::timestamp without time zone) ORDER BY btbl."nocopk"), ARRAY[]::timestamp without time zone[]) FROM "public"."_m2m_lots_events_events" j JOIN "public"."events" btbl ON btbl."nocopk" = j."events_id" WHERE j."lots_id" = base."nocopk") AS "spawned_date",
    (SELECT COALESCE(array_agg(((btbl."timestamp")::timestamp without time zone) ORDER BY btbl."nocopk"), ARRAY[]::timestamp without time zone[]) FROM "public"."_m2m_lots_events_events" j JOIN "public"."events" btbl ON btbl."nocopk" = j."events_id" WHERE j."lots_id" = base."nocopk") AS "first_event_date",
    (SELECT COALESCE(array_agg(((btbl."timestamp")::timestamp without time zone) ORDER BY btbl."nocopk"), ARRAY[]::timestamp without time zone[]) FROM "public"."_m2m_lots_events_events" j JOIN "public"."events" btbl ON btbl."nocopk" = j."events_id" WHERE j."lots_id" = base."nocopk") AS "last_event_date"
  FROM "public"."v_lots" base
)
SELECT comp.*,
  ('LOT-' || to_char((comp."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((comp."airtable_id")::text, (4)::int)) AS "lot_id",
  ('My Business') AS "label_company_lot",
  (CASE WHEN (NULLIF(comp."unit_size"::text,'') IS NOT NULL) THEN ("round"((comp."unit_size")::numeric, (2)::int) || ' lb') ELSE ('') END) AS "unit_lbs",
  (CASE WHEN (NULLIF(comp."inoculated_at"::text,'') IS NOT NULL) THEN ('Inoculated: ' || to_char((comp."inoculated_at")::timestamp, 'YYYY-MM-DD') || ' ') ELSE ('') END || '') AS "label_inoc_line",
  (CASE WHEN (NULLIF(comp."spawned_at"::text,'') IS NOT NULL) THEN ('Spawned: ' || to_char((comp."spawned_at")::timestamp, 'YYYY-MM-DD')) ELSE (CASE WHEN (NULLIF(comp."spawned_date"::text,'') IS NOT NULL) THEN ('Spawned: ' || to_char(((comp."spawned_date")[1])::timestamp, 'YYYY-MM-DD')) ELSE ('') END) END) AS "label_spawned_line",
  (CASE WHEN (NULLIF(comp."use_by"::text,'') IS NOT NULL) THEN ('Use by: ' || to_char(((comp."use_by"))::timestamp, 'YYYY-MM-DD')) ELSE ('') END) AS "label_useby_line",
  (CASE WHEN (comp."label_template") = ('Grain_Inoculated') THEN ('Grain: ' || comp."item_name_mat" || '') WHEN (comp."label_template") = ('LC_Flask_Inoculated') THEN ('Liquid Culture — Flask') WHEN (comp."label_template") = ('Plate_Inoculated') THEN (comp."item_name_mat" || '') WHEN (comp."label_template") = ('Bulk_Created') THEN (comp."item_name_mat" || '') WHEN (comp."label_template") = ('LC_Syringe_Received') THEN (comp."item_name_mat" || '') ELSE ('') END) AS "label_title_lot",
  (CASE WHEN (comp."label_template") = ('Grain_Inoculated') THEN (CASE WHEN (NULLIF(comp."unit_size"::text,'') IS NOT NULL) THEN ("round"((comp."unit_size")::numeric, (2)::int) || ' lb • ') ELSE ('') END || COALESCE(((comp."strain_species_strain")[1])::text, '') || ' ' || comp."vendor_name_mat" || '') WHEN (comp."label_template") = ('Plate_Inoculated') THEN (CASE WHEN (NULLIF(comp."strain_species_strain"::text,'') IS NOT NULL) THEN (((comp."strain_species_strain")[1])::text) ELSE (comp."notes") END || '') WHEN (comp."label_template") = ('LC_Flask_Inoculated') THEN (CASE WHEN (NULLIF(comp."remaining_volume_ml"::text,'') IS NOT NULL) THEN (comp."remaining_volume_ml" || ' ml • ') ELSE ('') END || COALESCE(((comp."strain_species_strain")[1])::text, '') || ' ' || comp."vendor_name_mat" || '') WHEN (comp."label_template") = ('LC_Syringe_Received') THEN (CASE WHEN (NULLIF(comp."remaining_volume_ml"::text,'') IS NOT NULL) THEN (comp."remaining_volume_ml" || ' ml • ') ELSE ('') END || COALESCE(((comp."strain_species_strain")[1])::text, '') || ' ' || comp."vendor_name" || ' ' || comp."vendor_batch" || '') WHEN (comp."label_template") = ('Bulk_Created') THEN (CASE WHEN (NULLIF(comp."unit_size"::text,'') IS NOT NULL) THEN ("round"((comp."unit_size")::numeric, (2)::int) || ' lb • ') ELSE ('') END || COALESCE(((comp."strain_species_strain")[1])::text, '') || ' ' || comp."vendor_name_mat" || '') ELSE ('') END) AS "label_subtitle_lot",
  ('Lot: ' || ('LOT-' || to_char((comp."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((comp."airtable_id")::text, (4)::int))) AS "label_footer_lot",
  (CASE WHEN (NULLIF(comp."received_date"::text,'') IS NOT NULL) THEN ('Received: ' || to_char((comp."received_date")::timestamp, 'YYYY-MM-DD')) ELSE (CASE WHEN (NULLIF(comp."sterilized_at"::text,'') IS NOT NULL) THEN (CASE WHEN ("lower"((comp."process_type_mat")::text) = 'pasteurize') THEN ('Pasteurized: ' || to_char((comp."sterilized_at")::timestamp, 'YYYY-MM-DD')) ELSE ('Sterilized: ' || to_char((comp."sterilized_at")::timestamp, 'YYYY-MM-DD')) END) ELSE ('') END) END) AS "label_proc_line",
  (CASE WHEN (NULLIF(comp."spawned_date"::text,'') IS NOT NULL) THEN (CASE WHEN (NULLIF(comp."inoculated_at_from_grain_inputs"::text,'') IS NOT NULL) THEN (COALESCE(((comp."item_name_mat_from_grain_inputs")[1])::text, '') || ' ' || to_char(((comp."inoculated_at_from_grain_inputs")[1])::timestamp, 'YYYY-MM-DD')) ELSE ('') END) ELSE ('') END) AS "label_graininputblocks_line",
  (CASE WHEN (NULLIF(comp."spawned_date"::text,'') IS NOT NULL) THEN (COALESCE(((comp."process_type_mat_from_substrate_inputs")[1])::text, '') || 'd ' || COALESCE(((comp."item_name_mat_from_substrate_inputs")[1])::text, '')) ELSE ('') END) AS "label_substrateinputblocks_line",
  ('https://airtable.com/appxJ59Wmyd96jXMm/pagWksRvwslppY76o(ByfiZ=' || comp."airtable_id") AS "public_link",
  ('https://airtable.com/appxJ59Wmyd96jXMm/pagJhBDbljrVzBkye(9APYL=' || comp."airtable_id") AS "public_link_dark_room",
  ('https://airtable.com/appxJ59Wmyd96jXMm/pagttgRxM4k6lahsp(jmVTq=' || comp."airtable_id") AS "public_link_fruiting",
  ('FIXME' || comp."airtable_id") AS "public_link_harvest",
  ('https://airtable.com/appxJ59Wmyd96jXMm/pagR4tAJvqmh3llqt(PivwV=' || comp."airtable_id") AS "public_link_spawn_to_bulk",
  ('https://airtable.com/appxJ59Wmyd96jXMm/paglNTehzE6kSB5zX(UPFEz=' || comp."airtable_id") AS "public_link_inoculate_flask",
  ('https://airtable.com/appxJ59Wmyd96jXMm/pagbsdJa1bNycfeCP(9boTG=' || comp."airtable_id") AS "public_link_inoculate_grain",
  ('FIXME' || comp."airtable_id") AS "public_link_freeze_dry_package",
  ('https://airtable.com/appxJ59Wmyd96jXMm/pagpd4iKvhBjM98NJ/preview(6Mp29=' || comp."airtable_id") AS "public_link_substrate_package",
  ('https://airtable.com/appxJ59Wmyd96jXMm/pagy6IGrvfVAVo9Sl(YckDK=' || comp."airtable_id") AS "public_link_lot_lineage"
FROM comp;

CREATE VIEW "public"."vc_products" AS
WITH comp AS (
  SELECT base.*,
    (SELECT COALESCE(array_agg(((btbl."name")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_items_item_id" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."products_id" = base."nocopk") AS "name",
    (SELECT COALESCE(array_agg(((btbl."category")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_items_item_id" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."products_id" = base."nocopk") AS "item_category",
    (SELECT COALESCE(array_agg(((btbl."name")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_items_package_item" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."products_id" = base."nocopk") AS "name_from_package_item",
    (SELECT COALESCE(array_agg(((btbl."category")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_items_package_item" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."products_id" = base."nocopk") AS "package_item_category",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."unit_size"::text,'') IS NOT NULL) THEN ("round"((btbl."unit_size")::numeric, (2)::int) || ' lb') ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."products_id" = base."nocopk") AS "unit_lbs",
    (SELECT COALESCE(array_agg(((btbl."unit_size")::numeric) ORDER BY btbl."nocopk"), ARRAY[]::numeric[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."products_id" = base."nocopk") AS "unit_size",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."inoculated_at"::text,'') IS NOT NULL) THEN ('Inoculated: ' || to_char((btbl."inoculated_at")::timestamp, 'YYYY-MM-DD') || ' ') ELSE ('') END || '' ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."products_id" = base."nocopk") AS "label_inoc_prod",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."spawned_at"::text,'') IS NOT NULL) THEN ('Spawned: ' || to_char((btbl."spawned_at")::timestamp, 'YYYY-MM-DD')) ELSE (CASE WHEN (NULLIF(btbl."spawned_date"::text,'') IS NOT NULL) THEN ('Spawned: ' || to_char(((btbl."spawned_date")[1])::timestamp, 'YYYY-MM-DD')) ELSE ('') END) END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."products_id" = base."nocopk") AS "label_spawned_prod",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."received_date"::text,'') IS NOT NULL) THEN ('Received: ' || to_char((btbl."received_date")::timestamp, 'YYYY-MM-DD')) ELSE (CASE WHEN (NULLIF(btbl."sterilized_at"::text,'') IS NOT NULL) THEN (CASE WHEN ("lower"((btbl."process_type_mat")::text) = 'pasteurize') THEN ('Pasteurized: ' || to_char((btbl."sterilized_at")::timestamp, 'YYYY-MM-DD')) ELSE ('Sterilized: ' || to_char((btbl."sterilized_at")::timestamp, 'YYYY-MM-DD')) END) ELSE ('') END) END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."products_id" = base."nocopk") AS "label_proc_prod",
    (SELECT COALESCE(array_agg(((btbl."process_type_from_steri_run_id")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_lots_origin_lots" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."products_id" = base."nocopk") AS "process_type",
    (SELECT COALESCE(array_agg(((btbl."species_strain")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_products_strains_strain_id" j JOIN "public"."strains" btbl ON btbl."nocopk" = j."strains_id" WHERE j."products_id" = base."nocopk") AS "species_strain",
    (SELECT COALESCE(array_agg(((btbl."regulated")::boolean) ORDER BY btbl."nocopk"), ARRAY[]::boolean[]) FROM "public"."_m2m_products_strains_strain_id" j JOIN "public"."strains" btbl ON btbl."nocopk" = j."strains_id" WHERE j."products_id" = base."nocopk") AS "origin_strain_regulated"
  FROM "public"."v_products" base
)
SELECT comp.*,
  ('PROD-' || to_char((comp."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((comp."airtable_id")::text, (4)::int)) AS "product_id",
  (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR (((comp."item_category_mat" = 'fresh_mushrooms'))))) THEN (CASE WHEN (NULLIF(comp."origin_strain_regulated"::text,'') IS NOT NULL) THEN ('https://www.regulatedbusiness.com/') ELSE ('https://www.mybusiness.com/') END) ELSE ('https://www.mybusiness.com/') END) AS "public_link",
  (CASE WHEN (NULLIF(comp."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR ((((comp."item_category_mat" = 'fresh_mushrooms')))) OR ((((comp."item_category_mat" = 'freezer_tray')))) OR ((((comp."item_category_mat" = 'fresh_tray')))))) THEN ('Regulated Business') ELSE ('My Business') END) ELSE ('My Business') END) AS "label_company_prod",
  (CASE WHEN (NULLIF(comp."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR ((((comp."item_category_mat" = 'fresh_mushrooms')))) OR ((((comp."item_category_mat" = 'freezer_tray')))) OR ((((comp."item_category_mat" = 'fresh_tray')))))) THEN ('RegulatedBusinessAddressAndContact') ELSE ('MyBuinessAddressAndContact') END) ELSE ('MyBuinessAddressAndContact') END) AS "label_companyaddress_prod",
  (CASE WHEN (NULLIF(comp."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR ((((comp."item_category_mat" = 'fresh_mushrooms')))) OR ((((comp."item_category_mat" = 'freezer_tray')))) OR ((((comp."item_category_mat" = 'fresh_tray')))) OR ((((comp."item_category_mat" = 'fruitingblock')))))) THEN ('') ELSE ('Disclaimer: Psilocybin is classified as a Schedule I controlled substance by the U.S. Drug Enforcement Administration (DEA). Unauthorized cultivation, possession, or distribution of psilocybin-containing mushrooms is illegal in most states. It is the responsibility of the buyer to research and comply with all local, state, and federal laws regarding mushroom cultivation. Please consult your local laws carefully before any attempt to grow mushrooms, as penalties for non-compliance can be significant.') END) ELSE ('') END) AS "label_disclaimer_prod",
  (CASE WHEN (NULLIF(comp."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR ((((comp."item_category_mat" = 'fresh_mushrooms')))) OR ((((comp."item_category_mat" = 'freezer_tray')))) OR ((((comp."item_category_mat" = 'fresh_tray')))))) THEN ('') ELSE (CASE WHEN (comp."item_category_mat" = 'fruiting_block') THEN ('MyBusinessOffering') ELSE ('') END) END) ELSE (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR ((((comp."item_category_mat" = 'fresh_mushrooms')))) OR ((((comp."item_category_mat" = 'fruiting_block')))))) THEN ('MyBusinessOffering') ELSE ('') END) END) AS "label_companyinfo_prod",
  (CASE WHEN (NULLIF(comp."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR ((((comp."item_category_mat" = 'fresh_mushrooms')))) OR ((((comp."item_category_mat" = 'freezer_tray')))) OR ((((comp."item_category_mat" = 'fresh_tray')))))) THEN ('') ELSE (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR (((((comp."item_category_mat" = 'fresh_mushrooms'))))))) THEN ('This product was produced in a home kitchen that is not subject to state licensure or inspection and that may also contain common food allergies such as tree nuts, peanuts, eggs, soy, wheat, milk, fish, and crustacean shellfish. This product is not intended for resale.') ELSE (CASE WHEN (comp."item_category_mat" = 'fruiting_block') THEN ('This product contains ingredients designed for mushroom cultivation. This product is not intended for human consumption.') ELSE ('') END) END) END) ELSE (CASE WHEN (((comp."item_category_mat" = 'freezedriedmushrooms') OR ((((comp."item_category_mat" = 'fresh_mushrooms')))))) THEN ('This product was produced in a home kitchen that is not subject to state licensure or inspection and that may also contain common food allergies such as tree nuts, peanuts, eggs, soy, wheat, milk, fish, and crustacean shellfish. This product is not intended for resale.') ELSE (CASE WHEN (comp."item_category_mat" = 'fruiting_block') THEN ('This product contains ingredients designed for mushroom cultivation. This product is not intended for human consumption.') ELSE ('') END) END) END) AS "label_cottage_prod",
  (CASE WHEN (comp."item_category_mat") = ('grain') THEN (comp."name_mat" || ' Grain') WHEN (comp."item_category_mat") = ('substrate') THEN (comp."name_mat" || ' Substrate') WHEN (comp."item_category_mat") = ('fruiting_block') THEN (comp."name_mat") WHEN (comp."item_category_mat") = ('lc_syringe') THEN (comp."name_mat") WHEN (comp."item_category_mat") = ('freezedriedmushrooms') THEN (comp."name_mat") WHEN (comp."item_category_mat") = ('freezer_tray') THEN (comp."name_mat") WHEN (comp."item_category_mat") = ('fresh_tray') THEN (comp."name_mat") WHEN (comp."item_category_mat") = ('fresh_mushrooms') THEN (comp."name_mat") ELSE ('') END) AS "label_title_prod",
  (CASE WHEN (comp."item_category_mat") = ('grain') THEN (CASE WHEN (NULLIF(comp."unit_lbs"::text,'') IS NOT NULL) THEN (COALESCE(((comp."unit_lbs")[1])::text, '') || ' • ' || COALESCE(((comp."process_type")[1])::text, '') || 'd') ELSE ('') END) WHEN (comp."item_category_mat") = ('substrate') THEN (CASE WHEN (NULLIF(comp."unit_lbs"::text,'') IS NOT NULL) THEN (COALESCE(((comp."unit_lbs")[1])::text, '') || ' • ' || COALESCE(((comp."process_type")[1])::text, '') || 'd') ELSE ('') END) WHEN (comp."item_category_mat") = ('fruiting_block') THEN (CASE WHEN (NULLIF(comp."unit_lbs"::text,'') IS NOT NULL) THEN (COALESCE(((comp."unit_lbs")[1])::text, '') || ' • ') ELSE (' ') END || COALESCE(((comp."species_strain")[1])::text, '') || '') WHEN (comp."item_category_mat") = ('lc_syringe') THEN (CASE WHEN (NULLIF(comp."net_volume_ml"::text,'') IS NOT NULL) THEN ("round"((comp."net_volume_ml")::numeric, (2)::int) || ' mL • ') ELSE ('') END || COALESCE(((comp."species_strain")[1])::text, '') || '') WHEN (comp."item_category_mat") = ('freezedriedmushrooms') THEN (CASE WHEN (NULLIF(comp."package_size_g"::text,'') IS NOT NULL) THEN ("round"((comp."package_size_g")::numeric, (2)::int) || ' g • ') ELSE ('') END || COALESCE(((comp."species_strain")[1])::text, '') || '') WHEN (comp."item_category_mat") = ('freezer_tray') THEN (CASE WHEN (NULLIF(comp."net_weight_g"::text,'') IS NOT NULL) THEN ("round"((comp."net_weight_g")::numeric, (2)::int) || ' g • ') ELSE ('') END || COALESCE(((comp."species_strain")[1])::text, '') || '') WHEN (comp."item_category_mat") = ('fresh_tray') THEN (CASE WHEN (NULLIF(comp."net_weight_g"::text,'') IS NOT NULL) THEN ("round"((comp."net_weight_g")::numeric, (2)::int) || ' g • ') ELSE ('') END || COALESCE(((comp."species_strain")[1])::text, '') || '') WHEN (comp."item_category_mat") = ('fresh_mushrooms') THEN (CASE WHEN (NULLIF(comp."package_size_g"::text,'') IS NOT NULL) THEN ("round"((comp."package_size_g")::numeric, (2)::int) || ' g • ') ELSE ('') END || COALESCE(((comp."species_strain")[1])::text, '') || '') ELSE ('') END) AS "label_subtitle_prod",
  (('PROD-' || to_char((comp."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((comp."airtable_id")::text, (4)::int))) AS "label_footer_prod",
  (CASE WHEN (NULLIF(comp."pack_date"::text,'') IS NOT NULL) THEN ('Packaged: ' || to_char(((comp."pack_date"))::timestamp, 'YYYY-MM-DD')) ELSE ('') END) AS "label_packaged_prod",
  (CASE WHEN (NULLIF(comp."use_by"::text,'') IS NOT NULL) THEN ('Use by: ' || to_char(((comp."use_by"))::timestamp, 'YYYY-MM-DD')) ELSE ('') END) AS "label_useby_prod"
FROM comp;

CREATE VIEW "public"."vc_items" AS SELECT * FROM "public"."v_items";

CREATE VIEW "public"."vc_events" AS
WITH comp AS (
  SELECT base.*,
    (SELECT COALESCE(array_agg(((btbl."status")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."events_id" = base."nocopk") AS "status_from_lot_id",
    (SELECT COALESCE(array_agg(((ltbl."name")::text) ORDER BY ltbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_events_products_product_id" j JOIN "public"."_m2m_products_locations_storage_location" j2 ON j2."products_id" = j."products_id" JOIN "public"."locations" ltbl ON ltbl."nocopk" = j2."locations_id" WHERE j."events_id" = base."nocopk") AS "storage_location_from_product_id",
    (SELECT COALESCE(array_agg('LOT-' || to_char((ltbl."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((ltbl."airtable_id")::text, (4)::int) ORDER BY ltbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."_m2m_lots_lots_grain_inputs" j2 ON j2."lots_id" = j."lots_id" JOIN "public"."lots" ltbl ON ltbl."nocopk" = j2."lots1_id" WHERE j."events_id" = base."nocopk") AS "grain_inputs_from_lot_id",
    (SELECT COALESCE(array_agg('LOT-' || to_char((ltbl."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((ltbl."airtable_id")::text, (4)::int) ORDER BY ltbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."_m2m_lots_lots_substrate_inputs" j2 ON j2."lots_id" = j."lots_id" JOIN "public"."lots" ltbl ON ltbl."nocopk" = j2."lots1_id" WHERE j."events_id" = base."nocopk") AS "substrate_inputs_from_lot_id",
    (SELECT COALESCE(array_agg(((btbl."vendor_name_mat")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."events_id" = base."nocopk") AS "vendor_name_from_lc_lot_id_from_lot_id",
    (SELECT COALESCE(array_agg(((btbl."strain_species_strain")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_events_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."events_id" = base."nocopk") AS "strain_species_strain_from_lot_id"
  FROM "public"."v_events" base
)
SELECT comp.*,
  ('EVENT-' || to_char((comp."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((comp."airtable_id")::text, (4)::int)) AS "event_id",
  (CASE WHEN (NULLIF(comp."timestamp"::text,'') IS NOT NULL) THEN (comp."timestamp") ELSE (comp."nc_created_at") END) AS "event_time_for_rollup"
FROM comp;

CREATE VIEW "public"."vc_locations" AS SELECT * FROM "public"."v_locations";

CREATE VIEW "public"."vc_sterilization_runs" AS
WITH comp AS (
  SELECT base.*,
    (SELECT COALESCE(array_agg(((btbl."default_unit_size")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_sterilization_runs_items_planned_item" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."sterilization_runs_id" = base."nocopk") AS "default_unit_size_from_planned_item",
    (SELECT COALESCE(array_agg(((btbl."item_id")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_sterilization_runs_items_planned_item" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."sterilization_runs_id" = base."nocopk") AS "planned_item_id",
    (SELECT COALESCE(array_agg(((btbl."name")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_sterilization_runs_items_planned_item" j JOIN "public"."items" btbl ON btbl."nocopk" = j."items_id" WHERE j."sterilization_runs_id" = base."nocopk") AS "planned_item_name",
    (SELECT COALESCE(array_agg(((btbl."recipe_id")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_sterilization_runs_recipes_planned_recipe" j JOIN "public"."recipes" btbl ON btbl."nocopk" = j."recipes_id" WHERE j."sterilization_runs_id" = base."nocopk") AS "recipe_id_from_planned_recipe",
    (SELECT COALESCE(array_agg(((btbl."name")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_sterilization_runs_recipes_planned_recipe" j JOIN "public"."recipes" btbl ON btbl."nocopk" = j."recipes_id" WHERE j."sterilization_runs_id" = base."nocopk") AS "name_from_planned_recipe"
  FROM "public"."v_sterilization_runs" base
)
SELECT comp.*,
  ('RUN-' || to_char((comp."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((comp."airtable_id")::text, (4)::int)) AS "steri_run_id"
FROM comp;

CREATE VIEW "public"."vc_print_queue" AS
WITH comp AS (
  SELECT base.*,
    (SELECT COALESCE(array_agg(((btbl."item_category_mat")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "item_category_mat_from_lot_id",
    (SELECT COALESCE(array_agg((('https://airtable.com/appxJ59Wmyd96jXMm/pagWksRvwslppY76o(ByfiZ=' || btbl."airtable_id")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "public_link_from_lot_id",
    (SELECT COALESCE(array_agg((('My Business')::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_company_lot_from_lot_id",
    (SELECT COALESCE(array_agg(((btbl."item_category_mat")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "item_category_mat_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR (((btbl."item_category_mat" = 'fresh_mushrooms'))))) THEN (CASE WHEN (NULLIF(btbl."origin_strain_regulated"::text,'') IS NOT NULL) THEN ('https://www.regulatedbusiness.com/') ELSE ('https://www.mybusiness.com/') END) ELSE ('https://www.mybusiness.com/') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "public_link_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."spawned_date"::text,'') IS NOT NULL) THEN (COALESCE(((btbl."process_type_mat_from_substrate_inputs")[1])::text, '') || 'd ' || COALESCE(((btbl."item_name_mat_from_substrate_inputs")[1])::text, '')) ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_substrateinputblocks_line_from_lot_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."spawned_date"::text,'') IS NOT NULL) THEN (CASE WHEN (NULLIF(btbl."inoculated_at_from_grain_inputs"::text,'') IS NOT NULL) THEN (COALESCE(((btbl."item_name_mat_from_grain_inputs")[1])::text, '') || ' ' || to_char(((btbl."inoculated_at_from_grain_inputs")[1])::timestamp, 'YYYY-MM-DD')) ELSE ('') END) ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_graininputblocks_line_from_lot_id",
    (SELECT COALESCE(array_agg('Lot: ' || ('LOT-' || to_char((btbl."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((btbl."airtable_id")::text, (4)::int)) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_footer_lot_from_lot_id",
    (SELECT COALESCE(array_agg(CASE WHEN (btbl."label_template") = ('Grain_Inoculated') THEN (CASE WHEN (NULLIF(btbl."unit_size"::text,'') IS NOT NULL) THEN ("round"((btbl."unit_size")::numeric, (2)::int) || ' lb • ') ELSE ('') END || COALESCE(((btbl."strain_species_strain")[1])::text, '') || ' ' || btbl."vendor_name_mat" || '') WHEN (btbl."label_template") = ('Plate_Inoculated') THEN (CASE WHEN (NULLIF(btbl."strain_species_strain"::text,'') IS NOT NULL) THEN (((btbl."strain_species_strain")[1])::text) ELSE (btbl."notes") END || '') WHEN (btbl."label_template") = ('LC_Flask_Inoculated') THEN (CASE WHEN (NULLIF(btbl."remaining_volume_ml"::text,'') IS NOT NULL) THEN (btbl."remaining_volume_ml" || ' ml • ') ELSE ('') END || COALESCE(((btbl."strain_species_strain")[1])::text, '') || ' ' || btbl."vendor_name_mat" || '') WHEN (btbl."label_template") = ('LC_Syringe_Received') THEN (CASE WHEN (NULLIF(btbl."remaining_volume_ml"::text,'') IS NOT NULL) THEN (btbl."remaining_volume_ml" || ' ml • ') ELSE ('') END || COALESCE(((btbl."strain_species_strain")[1])::text, '') || ' ' || btbl."vendor_name" || ' ' || btbl."vendor_batch" || '') WHEN (btbl."label_template") = ('Bulk_Created') THEN (CASE WHEN (NULLIF(btbl."unit_size"::text,'') IS NOT NULL) THEN ("round"((btbl."unit_size")::numeric, (2)::int) || ' lb • ') ELSE ('') END || COALESCE(((btbl."strain_species_strain")[1])::text, '') || ' ' || btbl."vendor_name_mat" || '') ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_subtitle_lot_from_lot_id",
    (SELECT COALESCE(array_agg(((CASE WHEN (btbl."label_template") = ('Grain_Inoculated') THEN ('Grain: ' || btbl."item_name_mat" || '') WHEN (btbl."label_template") = ('LC_Flask_Inoculated') THEN ('Liquid Culture — Flask') WHEN (btbl."label_template") = ('Plate_Inoculated') THEN (btbl."item_name_mat" || '') WHEN (btbl."label_template") = ('Bulk_Created') THEN (btbl."item_name_mat" || '') WHEN (btbl."label_template") = ('LC_Syringe_Received') THEN (btbl."item_name_mat" || '') ELSE ('') END)::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_title_lot_from_lot_id",
    (SELECT COALESCE(array_agg(((btbl."label_template")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_template_from_lot_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."use_by"::text,'') IS NOT NULL) THEN ('Use by: ' || to_char(((btbl."use_by"))::timestamp, 'YYYY-MM-DD')) ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_useby_line_from_lot_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."spawned_at"::text,'') IS NOT NULL) THEN ('Spawned: ' || to_char((btbl."spawned_at")::timestamp, 'YYYY-MM-DD')) ELSE (CASE WHEN (NULLIF(btbl."spawned_date"::text,'') IS NOT NULL) THEN ('Spawned: ' || to_char(((btbl."spawned_date")[1])::timestamp, 'YYYY-MM-DD')) ELSE ('') END) END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_spawned_line_from_lot_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."inoculated_at"::text,'') IS NOT NULL) THEN ('Inoculated: ' || to_char((btbl."inoculated_at")::timestamp, 'YYYY-MM-DD') || ' ') ELSE ('') END || '' ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_inoc_line_from_lot_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."received_date"::text,'') IS NOT NULL) THEN ('Received: ' || to_char((btbl."received_date")::timestamp, 'YYYY-MM-DD')) ELSE (CASE WHEN (NULLIF(btbl."sterilized_at"::text,'') IS NOT NULL) THEN (CASE WHEN ("lower"((btbl."process_type_mat")::text) = 'pasteurize') THEN ('Pasteurized: ' || to_char((btbl."sterilized_at")::timestamp, 'YYYY-MM-DD')) ELSE ('Sterilized: ' || to_char((btbl."sterilized_at")::timestamp, 'YYYY-MM-DD')) END) ELSE ('') END) END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_lots_lot_id" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."print_queue_id" = base."nocopk") AS "label_proc_line_from_lot_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR ((((btbl."item_category_mat" = 'fresh_mushrooms')))) OR ((((btbl."item_category_mat" = 'freezer_tray')))) OR ((((btbl."item_category_mat" = 'fresh_tray')))))) THEN ('Regulated Business') ELSE ('My Business') END) ELSE ('My Business') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_company_prod_from_product_id",
    (SELECT COALESCE(array_agg(((CASE WHEN (btbl."item_category_mat") = ('grain') THEN (btbl."name_mat" || ' Grain') WHEN (btbl."item_category_mat") = ('substrate') THEN (btbl."name_mat" || ' Substrate') WHEN (btbl."item_category_mat") = ('fruiting_block') THEN (btbl."name_mat") WHEN (btbl."item_category_mat") = ('lc_syringe') THEN (btbl."name_mat") WHEN (btbl."item_category_mat") = ('freezedriedmushrooms') THEN (btbl."name_mat") WHEN (btbl."item_category_mat") = ('freezer_tray') THEN (btbl."name_mat") WHEN (btbl."item_category_mat") = ('fresh_tray') THEN (btbl."name_mat") WHEN (btbl."item_category_mat") = ('fresh_mushrooms') THEN (btbl."name_mat") ELSE ('') END)::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_title_prod_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (btbl."item_category_mat") = ('grain') THEN (CASE WHEN (NULLIF(btbl."unit_lbs"::text,'') IS NOT NULL) THEN (COALESCE(((btbl."unit_lbs")[1])::text, '') || ' • ' || COALESCE(((btbl."process_type")[1])::text, '') || 'd') ELSE ('') END) WHEN (btbl."item_category_mat") = ('substrate') THEN (CASE WHEN (NULLIF(btbl."unit_lbs"::text,'') IS NOT NULL) THEN (COALESCE(((btbl."unit_lbs")[1])::text, '') || ' • ' || COALESCE(((btbl."process_type")[1])::text, '') || 'd') ELSE ('') END) WHEN (btbl."item_category_mat") = ('fruiting_block') THEN (CASE WHEN (NULLIF(btbl."unit_lbs"::text,'') IS NOT NULL) THEN (COALESCE(((btbl."unit_lbs")[1])::text, '') || ' • ') ELSE (' ') END || COALESCE(((btbl."species_strain")[1])::text, '') || '') WHEN (btbl."item_category_mat") = ('lc_syringe') THEN (CASE WHEN (NULLIF(btbl."net_volume_ml"::text,'') IS NOT NULL) THEN ("round"((btbl."net_volume_ml")::numeric, (2)::int) || ' mL • ') ELSE ('') END || COALESCE(((btbl."species_strain")[1])::text, '') || '') WHEN (btbl."item_category_mat") = ('freezedriedmushrooms') THEN (CASE WHEN (NULLIF(btbl."package_size_g"::text,'') IS NOT NULL) THEN ("round"((btbl."package_size_g")::numeric, (2)::int) || ' g • ') ELSE ('') END || COALESCE(((btbl."species_strain")[1])::text, '') || '') WHEN (btbl."item_category_mat") = ('freezer_tray') THEN (CASE WHEN (NULLIF(btbl."net_weight_g"::text,'') IS NOT NULL) THEN ("round"((btbl."net_weight_g")::numeric, (2)::int) || ' g • ') ELSE ('') END || COALESCE(((btbl."species_strain")[1])::text, '') || '') WHEN (btbl."item_category_mat") = ('fresh_tray') THEN (CASE WHEN (NULLIF(btbl."net_weight_g"::text,'') IS NOT NULL) THEN ("round"((btbl."net_weight_g")::numeric, (2)::int) || ' g • ') ELSE ('') END || COALESCE(((btbl."species_strain")[1])::text, '') || '') WHEN (btbl."item_category_mat") = ('fresh_mushrooms') THEN (CASE WHEN (NULLIF(btbl."package_size_g"::text,'') IS NOT NULL) THEN ("round"((btbl."package_size_g")::numeric, (2)::int) || ' g • ') ELSE ('') END || COALESCE(((btbl."species_strain")[1])::text, '') || '') ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_subtitle_prod_from_product_id",
    (SELECT COALESCE(array_agg(('PROD-' || to_char((btbl."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((btbl."airtable_id")::text, (4)::int)) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_footer_prod_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR ((((btbl."item_category_mat" = 'fresh_mushrooms')))) OR ((((btbl."item_category_mat" = 'freezer_tray')))) OR ((((btbl."item_category_mat" = 'fresh_tray')))))) THEN ('') ELSE (CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR (((((btbl."item_category_mat" = 'fresh_mushrooms'))))))) THEN ('This product was produced in a home kitchen that is not subject to state licensure or inspection and that may also contain common food allergies such as tree nuts, peanuts, eggs, soy, wheat, milk, fish, and crustacean shellfish. This product is not intended for resale.') ELSE (CASE WHEN (btbl."item_category_mat" = 'fruiting_block') THEN ('This product contains ingredients designed for mushroom cultivation. This product is not intended for human consumption.') ELSE ('') END) END) END) ELSE (CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR ((((btbl."item_category_mat" = 'fresh_mushrooms')))))) THEN ('This product was produced in a home kitchen that is not subject to state licensure or inspection and that may also contain common food allergies such as tree nuts, peanuts, eggs, soy, wheat, milk, fish, and crustacean shellfish. This product is not intended for resale.') ELSE (CASE WHEN (btbl."item_category_mat" = 'fruiting_block') THEN ('This product contains ingredients designed for mushroom cultivation. This product is not intended for human consumption.') ELSE ('') END) END) END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_cottage_prod_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR ((((btbl."item_category_mat" = 'fresh_mushrooms')))) OR ((((btbl."item_category_mat" = 'freezer_tray')))) OR ((((btbl."item_category_mat" = 'fresh_tray')))))) THEN ('') ELSE (CASE WHEN (btbl."item_category_mat" = 'fruiting_block') THEN ('MyBusinessOffering') ELSE ('') END) END) ELSE (CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR ((((btbl."item_category_mat" = 'fresh_mushrooms')))) OR ((((btbl."item_category_mat" = 'fruiting_block')))))) THEN ('MyBusinessOffering') ELSE ('') END) END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_companyinfo_prod_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR ((((btbl."item_category_mat" = 'fresh_mushrooms')))) OR ((((btbl."item_category_mat" = 'freezer_tray')))) OR ((((btbl."item_category_mat" = 'fresh_tray')))) OR ((((btbl."item_category_mat" = 'fruitingblock')))))) THEN ('') ELSE ('Disclaimer: Psilocybin is classified as a Schedule I controlled substance by the U.S. Drug Enforcement Administration (DEA). Unauthorized cultivation, possession, or distribution of psilocybin-containing mushrooms is illegal in most states. It is the responsibility of the buyer to research and comply with all local, state, and federal laws regarding mushroom cultivation. Please consult your local laws carefully before any attempt to grow mushrooms, as penalties for non-compliance can be significant.') END) ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_disclaimer_prod_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."origin_strain_regulated"::text,'') IS NOT NULL) THEN (CASE WHEN (((btbl."item_category_mat" = 'freezedriedmushrooms') OR ((((btbl."item_category_mat" = 'fresh_mushrooms')))) OR ((((btbl."item_category_mat" = 'freezer_tray')))) OR ((((btbl."item_category_mat" = 'fresh_tray')))))) THEN ('RegulatedBusinessAddressAndContact') ELSE ('MyBuinessAddressAndContact') END) ELSE ('MyBuinessAddressAndContact') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_companyaddress_prod_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."pack_date"::text,'') IS NOT NULL) THEN ('Packaged: ' || to_char(((btbl."pack_date"))::timestamp, 'YYYY-MM-DD')) ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_packaged_prod_from_product_id",
    (SELECT COALESCE(array_agg(CASE WHEN (NULLIF(btbl."use_by"::text,'') IS NOT NULL) THEN ('Use by: ' || to_char(((btbl."use_by"))::timestamp, 'YYYY-MM-DD')) ELSE ('') END ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_useby_prod_from_product_id",
    (SELECT COALESCE(array_agg(((btbl."label_proc_prod")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_proc_prod_from_product_id",
    (SELECT COALESCE(array_agg(((btbl."label_spawned_prod")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_spawned_prod_from_product_id",
    (SELECT COALESCE(array_agg(((btbl."label_inoc_prod")::text) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_print_queue_products_product_id" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."print_queue_id" = base."nocopk") AS "label_inoc_prod_from_product_id"
  FROM "public"."v_print_queue" base
)
SELECT comp.*,
  ('PRINT-' || to_char((comp."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((comp."airtable_id")::text, (4)::int)) AS "print_id",
  (CASE WHEN (comp."source_kind" = 'steri_sheet') THEN ('ZEBRA') ELSE (CASE WHEN ((((('fresh_mushrooms')::text = ANY((comp."item_category_mat_from_product_id")::text[]))) OR (((((('freezer_tray')::text = ANY((comp."item_category_mat_from_product_id")::text[])))))) OR (((((('fresh_tray')::text = ANY((comp."item_category_mat_from_product_id")::text[])))))) OR (((((('fresh_mushrooms')::text = ANY((comp."item_category_mat_from_lot_id")::text[])))))) OR (((((('freezer_tray')::text = ANY((comp."item_category_mat_from_lot_id")::text[])))))) OR (((((('fresh_tray')::text = ANY((comp."item_category_mat_from_lot_id")::text[])))))))) THEN ('TRAYS') ELSE ('ZEBRA') END) END) AS "print_target"
FROM comp;

CREATE VIEW "public"."vc_ecommerce" AS
WITH comp AS (
  SELECT base.*,
    (SELECT COALESCE(array_agg('PROD-' || to_char((btbl."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((btbl."airtable_id")::text, (4)::int) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_ecommerce_products_products" j JOIN "public"."vc_products" btbl ON btbl."nocopk" = j."products_id" WHERE j."ecommerce_id" = base."nocopk") AS "available_from_products",
    (SELECT COALESCE(array_agg('LOT-' || to_char((btbl."nc_created_at")::timestamp, 'YYMMDD') || '-' || "right"((btbl."airtable_id")::text, (4)::int) ORDER BY btbl."nocopk"), ARRAY[]::text[]) FROM "public"."_m2m_ecommerce_lots_lots" j JOIN "public"."vc_lots" btbl ON btbl."nocopk" = j."lots_id" WHERE j."ecommerce_id" = base."nocopk") AS "available_from_lots"
  FROM "public"."v_ecommerce" base
)
SELECT comp.*
FROM comp;

CREATE VIEW "public"."vc_ecommerce_orders" AS SELECT * FROM "public"."v_ecommerce_orders";

COMMIT;
