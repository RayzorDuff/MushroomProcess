──────────────────────────────────────────────
Interface Name: Inoculate
──────────────────────────────────────────────

Purpose:
Source-first batch inoculation. The operator selects ONE source lot
(liquid culture flask, plate, grain, etc.), then selects one or more
target lots. The interface writes the targets into the source
`target_lot_ids` field and updates other inoculation parameters
(e.g. `lc_volume_ml`, `override_inoc_time`, `operator`). The
“Inoculate” action is triggered by setting `action = "Inoculate"`
on the SOURCE lot. The automation then runs inoculate_multiple.js,
which:

- Uses the selected source lot (lot_id) and its `target_lot_ids`
  to determine all target lots.
- Uses `lc_volume_ml` on the source as the volume PER TARGET
  (for liquid sources).
- Sets `status = Colonizing` and timestamps on each target.
- Links each target back to the source via `source_lot_id`.
- Copies `strain_id` from source to every target.
- Updates `remaining_volume_ml` and `status` on the source
  if it is a liquid culture and becomes consumed.

──────────────────────────────────────────────

1. Data Source

──────────────────────────────────────────────
Table: lots
Source: NocoDB API (previously Airtable base “MushroomProcess”)
Primary key: lot_id

Additional tables used by automation (not directly in interface):

- items  (for category lookup)
- events (for logging “Inoculated” events)

──────────────────────────────────────────────

2. Source List (Left Panel)

──────────────────────────────────────────────
The primary record list on the left shows candidate SOURCE lots
that can be used to inoculate other lots.

Filters:

- item_category has any of:
    - "lc_flask"
    - "plate"
    - "grain"
    - (add "lc_syringe" if you ever track those as lots)

- status is any of:
    - "Sterilized"
    - "Sealed"
    - "Ready"
    (adjust to match the actual “ready to use” statuses used in lots)

Example NocoDB filter (pseudo):

where = {
  "item_category": { "in": ["lc_flask","plate","grain"] },
  "status":        { "in": ["Sterilized","Sealed","Ready"] }
}

Grouping:

- Group by item_category → strain_id → sterilized_at

List item display:

- Field 1: lot_id
- Field 2: item_category
- Optional: remaining_volume_ml (for liquid cultures)

Behavior:

- Clicking a row selects that SOURCE lot and populates the record
  detail panel on the right.

──────────────────────────────────────────────

3. Source Detail Form (Right Panel)

──────────────────────────────────────────────
The record detail form shows the selected SOURCE lot and allows
the operator to configure inoculation parameters and target lots.

Title field: lot_id

Visible / editable fields on the SOURCE lot:

- item_id           (read-only; context of the source)
- strain_id         (read-only; propagated to all targets by script)
- unit_size         (read-only)
- total_volume_ml   (read-only)
- remaining_volume_ml (read-only; especially for liquid sources)
- lc_volume_ml      (numeric; REQUIRED for liquid sources; volume
                     PER target lot, in ml)
- target_lot_ids    (link to multiple lots; the TARGET lots to inoculate)
- override_inoc_time (optional datetime; if set, becomes inoculated_at)
- operator          (text / select; who is performing the inoculation)
- notes             (text; any comments about this batch)
- ui_error          (read-only; error messages set by automation)
- validation        (read-only; summary status / validation field)

Field semantics:

- lot_id           : the source lot’s ID (primary key).
- target_lot_ids   : multi-link field. All linked lots are treated as
                     TARGET lots by inoculate_multiple.js.
- lc_volume_ml     : volume from this source per target. Total required
                     volume = lc_volume_ml × number of targets.
- strain_id        : inoculate_multiple.js copies this value onto each
                     target lot during processing.
- ui_error         : any validation or runtime error is written here by
                     the script; the interface simply displays it.

──────────────────────────────────────────────

4. Target Lot Selection (via target_lot_ids)

──────────────────────────────────────────────
The operator chooses target lots by editing the `target_lot_ids`
link field on the source record.

Typical filter used when choosing targets (within the link field’s
picker dialog):

- item_category has any of ["grain", "lc_flask", "plate"]
- status is any of ["Sterilized","Sealed","Ready"]

Targets should be un-inoculated recipient lots that will go to
status “Colonizing” after inoculation.

When the operator finishes selecting targets, the source record’s
`target_lot_ids` will contain all target lot IDs used by the
automation.

──────────────────────────────────────────────

5. Inoculate Button

──────────────────────────────────────────────
A button is placed in the source record detail form.

Label: "Inoculate Lot"  (or "Inoculate Targets" if you prefer)

Type: Update record

Configuration:

- Record source: current record detail (SOURCE lot)
- Update:
    - Field: action
      Value: "Inoculate"

- Label after: "Inoculated!"
- Show check icon: true

Behavior:

- The interface itself only updates `action = "Inoculate"` on the
  SOURCE lot. It does not directly modify targets.
- An automation watches the lots table and when a record’s
  action field is "Inoculate", it runs inoculate_multiple.js with
  the lotRecordId of that SOURCE row.
- After the script completes successfully it clears action and
  ui_error, updates source volumes and statuses, updates every
  target lot, and logs Inoculated events.

──────────────────────────────────────────────

6. Derived NocoDB API Behavior (reference)

──────────────────────────────────────────────
Fetch source lots (left panel):

GET /api/v2/tables/lots/rows?where={
  "item_category":{"in":["lc_flask","plate","grain"]},
  "status":{"in":["Sterilized","Sealed","Ready"]}
}

Update source lot from the interface form:

PATCH /api/v2/tables/lots/rows/{{source_lot_id}} {
  "lc_volume_ml": <perTargetMl>,
  "target_lot_ids": [<targetLotId1>, <targetLotId2>, ...],
  "override_inoc_time": <optional ISO timestamp>,
  "operator": "<name>",
  "notes": "<text>"
}

Trigger inoculation:

PATCH /api/v2/tables/lots/rows/{{source_lot_id}} {
  "action": "Inoculate"
}

Automation / backend then calls inoculate_multiple.js
with lotRecordId = {{source_lot_id}}.

──────────────────────────────────────────────

7. Retool Layout Summary (for migration)

──────────────────────────────────────────────
Panels:

Left: grouped table of SOURCE lots (see Section 2).
Right: form for selected SOURCE lot, including `target_lot_ids`,
       `lc_volume_ml`, `override_inoc_time`, `operator`, `notes`,
       `ui_error`, and the "Inoculate Lot" button.

Operator flow:

1) Pick a source lot in the left table.
2) In the right form:
   - Set lc_volume_ml (if using LC source).
   - Select one or more target lots into target_lot_ids.
   - Optionally set override_inoc_time, operator, notes.
3) Click "Inoculate Lot":
   - Sets action = "Inoculate" on the source.
   - Automation runs inoculate_multiple.js to process all targets.

──────────────────────────────────────────────

End of File

──────────────────────────────────────────────
